
# ๐ README โ ๐ฎ๐ท ูุงุฑุณ

## ๐ ูุณุฎู ุงูฺฏูุณ

* [English](README.md)
---

## ๐ฏ ูุฏู: ุจุงุฒุงุจ ุฏุงุฏู ุงุฒ Longhorn PVC ุจุฏูู Kubernetes/etcd

ฺฏุงู ููฺฉู ุงุณุช ฺฉูุงุณุชุฑ Kubernetes ู etcd/ฺฉูุชุฑูโูพูู ุงุฒ ฺฉุงุฑ ุจูุชุฏ ู ุฏุณุชุฑุณ ูุณุชูู ุจู PVCูุง ูุฒ ุงุฒ ุทุฑู K8s ุงูฺฉุงูโูพุฐุฑ ูุจุงุดุฏ.
ุงู ุฑุงูููุง ุชูุถุญ ูโุฏูุฏ ฺฺฏููู ูโุชูุงู **ุจูโุทูุฑ ูุณุชูู** ุจู replicaูุง ูุงูฺฏโููุฑู ุฑู ููุฏ ุฏุณุชุฑุณ ฺฏุฑูุชุ ุขูโูุง ุฑุง ุจุง Longhorn Engine ุจูโุตูุฑุช **ุฏุณุชฺฏุงู ุจูุงฺฉ** ุงฺฉุณูพูุฒ ฺฉุฑุฏุ ุณูพุณ ูููุช ูููุฏ ู ุฏุงุฏูโูุง (ูุงูโูุง ุง ุฏุชุงุจุณ) ุฑุง ุจุงุฒุงุจ ฺฉุฑุฏ.

โ๏ธ ุงู ุฑูุด ุจุฑุง **ุจุงุฒุงุจ ุขููุงู** ุงุณุชุ ูู ุงุฌุฑุง ุณุฑูุณ ุฑู ููุงู ุฏุงุฏูโูุง.

---

## ๐งช ุชุณุชโุดุฏู ุฑู

* **ุณุณุชูโุนุงูู:** Ubuntu 20.04 / 22.04
* **Runtime:** containerd + `nerdctl` (ูุงุฒููุฏ privileged)
* **Longhorn Engine:** v1.5.3
* **ูุงูโุณุณุชูโูุง:** ext4 ู xfs (ุจุฑุง xfs ุงุฒ `-o nouuid` ุงุณุชูุงุฏู ูโุดูุฏ)
* **ุณุฑูุณโูุง/ุฏุงุฏูโูุง ุจุงุฒุงุจโุดุฏู:**

  * Jira, Confluence, PostgreSQL (DB ุณุฑูุณโูุง)
  * GitLab (artifacts, uploads, registry, backups)
  * Kafka
  * Elasticsearch
  * ClickHouse

---

## ๐ ูุฑุงุญู ุฏุณุช (ุฎูุงุตู)

1. **ูุณุช PVCูุง ุฑู ููุฏ:**

   ```bash
   ls /var/lib/longhorn/replicas/
   ```

2. **ุงูุชุฎุงุจ PVC ู ูุดุงูุฏู ูุชุงุฏุชุง:**

   ```bash
   PVC=/var/lib/longhorn/replicas/pvc-1304f0e2-...
   cat "$PVC/volume.meta"
   ```

3. **ุฑุงูโุงูุฏุงุฒ Longhorn Engine:**

   ```bash
   nerdctl run -v /dev:/host/dev -v /proc:/host/proc \
     -v "$PVC:/volume" --privileged \
     longhornio/longhorn-engine:v1.5.3 \
     launch-simple-longhorn pvc-1304f0e2-... 10737418240
   ```

4. **ูพุฏุง ฺฉุฑุฏู ุฏุณฺฉ ู ูููุช ฺฉุฑุฏู:**

   ```bash
   lsblk
   mkdir -p /mnt/recover
   # ext4:
   mount -o ro /dev/sdX /mnt/recover
   # xfs:
   mount -o ro,nouuid /dev/sdX /mnt/recover
   ```

5. **ููููู ูุญุชูุง (ูุซุงู GitLab):**

   ```
   /mnt/recover/
     gitlab-artifacts  gitlab-backups  gitlab-uploads  registry  ...
   ```

6. **ุจุงุฒุงุจ ุฏุชุงุจุณโูุง (ูุซุงู PostgreSQL):**

   ```bash
   nerdctl run --rm --network=host \
     -v /mnt/recover:/var/lib/postgresql/data \
     postgres:16.3
   # ุณูพุณ pg_dump ุจุฑุง ุฎุฑูุฌ ฺฏุฑูุชู
   ```

---

## ๐ ูุซุงูโูุง

* **Jira/Confluence (PostgreSQL):**
  ูููุช โ ุงุฌุฑุง Postgres ููโูุณุฎู โ ฺฏุฑูุชู `pg_dump`

* **GitLab:**
  ูุณุฑูุง `gitlab-artifacts/`, `gitlab-uploads/`, `registry/`, `gitlab-backups/` ุฑุง ฺฉูพ ฺฉูุฏ.

* **Kafka / Elasticsearch / ClickHouse:**
  ุฏุงุฏูโูุง ุฑุง ฺฉูพ ฺฉูุฏ ู ุฏุฑ ุตูุฑุช ูุงุฒ ุณุฑูุณ ููโูุณุฎู ุฑุง ุฑู **ฺฉูพ ุฏุงุฏูโูุง** ุจุงูุง ุจุงูุฑุฏ.

---

## โ๏ธ ูุดุฏุงุฑูุง ู ูฺฉุงุช ุงูู

* ููุดู ุงุจุชุฏุง **Read-Only** ูููุช ฺฉูุฏ.
* ุจุฑุง xfs ุงุฒ `-o ro,nouuid` ุงุณุชูุงุฏู ฺฉูุฏ.
* ุฏุฑ ุตูุฑุช ูุงุฒ ุจู **ููุดุชู (RW)**ุ ุงุจุชุฏุง ุจุง `dd` ุง ุงุจุฒุงุฑ ูุดุงุจู ฺฉ **ฺฉูพ ุจูุงฺฉโุฏุณุชฺฏุงู** ุจฺฏุฑุฏ.
* ุฑู ููุฏ ฺฉุงุฑ ฺฉูุฏ ฺฉู replica ฺฉุงูู ุฏุงุฑุฏ.
* ุงฺฏุฑ ูุงูโุณุณุชู ุดูุงุณุง ูุดุฏุ ููฺฉู ุงุณุช LVM ุง RAID ุจุงุดุฏ. ุงุจุชุฏุง ุจุง `file -s` ุจุฑุฑุณ ฺฉูุฏ.

---

## ๐๏ธ ุงุณฺฉุฑูพุช: `auto-recover-longhorn.sh`

ุงู ุงุณฺฉุฑูพุช ูุฑุงุญู ุจุงูุง ุฑุง ุฎูุฏฺฉุงุฑ ูโฺฉูุฏ:

* ุฎูุงูุฏู `volume.meta` ู ุงุณุชุฎุฑุงุฌ `Size` ู `BaseName`
* ุงุฌุฑุง Longhorn Engine
* ุดูุงุณุง ุฎูุฏฺฉุงุฑ ุฏุณุชฺฏุงู ุจูุงฺฉ ุฌุฏุฏ
* ุชุดุฎุต ููุน ูุงูโุณุณุชู ู ูููุช ุงูู (RO) ุฑู `/mnt/<BaseName>`
* ูพุดุชุจุงู ุงุฒ xfs (`nouuid`)
* ุงูฺฉุงู Cleanup ุณุฑุน (unmount ู stop)

> ูุงุฒููุฏโูุง: `nerdctl` ุง `docker`, `jq`, `lsblk`, `blkid`, `mount`, `awk`, `sed`

(ฺฉู ุงุณฺฉุฑูพุช ุจุฏูู ุชุบุฑ ุฏุฑ ูพุงู README ูุฑุงุฑ ูโฺฏุฑุฏ โ)

---

## ๐ ุงุฌุฑุง ููููู ุงุณฺฉุฑูพุช

```bash
sudo ./auto-recover-longhorn.sh \
  --pvc-path /var/lib/longhorn/replicas/pvc-1304f0e2-... \
  --engine-version v1.5.3
```

ุณูพุณ ูุณุฑ ูููุช:

```
/mnt/pvc-1304f0e2-...
  gitlab-artifacts  gitlab-backups  gitlab-uploads  registry  ...
```

---

ูโุฎูุง ูู ููู ุจุงุฒููุณ ุฑู ุจุง ุงุณฺฉุฑูพุช ฺฉุงูู (`auto-recover-longhorn.sh`) ุจุฑุงุช ุจุฐุงุฑู ุชู ฺฉ ูุงู Markdown ุชูุฒ (ุจุง ฺฉุฏ ู ูุงูุงุช ฺฉุงูู) ุชุง ูุณุชูู ุฌุงฺฏุฒู README ุจุดูุ
